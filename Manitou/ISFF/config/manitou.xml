<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- Copyright 2005 UCAR, NCAR, All Rights Reserved -->

<project
    xmlns="http://www.eol.ucar.edu/nidas"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.eol.ucar.edu/nidas nidas.xsd"
    name="Manitou"
    system="ISFF"
    version="$LastChangedRevision$">

    <sensorcatalog>
        <serialSensor ID="CSAT3" class="isff.CSAT3_Sonic"
            baud="9600" parity="none" databits="8" stopbits="1" timeout="1">
            <parameter name="soniclog" type="string" value="/var/log/isfs/${DSM}_${PROJECT}_csat3.log"/>
            <sample id="1" rate="60">
                <variable name="u" units="m/s"/>
                <variable name="v" units="m/s"/>
                <variable name="w" units="m/s"/>
                <variable name="tc" units="degC"/>
                <variable name="diag" units=""/>
                <variable name="spd" units="m/s"/>
                <variable name="dir" units="deg"/>
            </sample> 
            <message separator="\x55\xaa" position="end" length="10"/>
        </serialSensor>
        <serialSensor ID="CSAT3_with_Krypton" IDREF="CSAT3">
            <sample id="2">
                <variable name="kh2oV" units="V"/>
                <variable name="kh2o" units="g/m^3"/>
            </sample>
        </serialSensor>

        <!-- LICOR 7500 -->
        <serialSensor ID="LICOR_7500" class="DSMSerialSensor"
            baud="19200" parity="none" databits="8" stopbits="1">
            <sample id="1" scanfFormat="%f%f%f%f%f%f">
                <variable name="co2raw" units=""/>
                <variable name="co2" units="mmol/m^3"/>
                <variable name="h2oraw" units=""/>
                <variable name="h2o" units="mmol/m^3">
                    <linear units="g/m^3" slope="18.0e-3" intercept="0.0"/>
                </variable>
                <variable name="Tcell" units="degC"/>
                <variable name="Pcell" units="kPa"/>
            </sample>
            <message separator="\n" position="end" length="0"/>
        </serialSensor>

       <serialSensor ID="NCAR_SHT" class="DSMSerialSensor"
            baud="9600" parity="none" databits="8" stopbits="1">
            <!-- TRH004 23.35 26.76 6301 820\r\n -->
            <sample id="1" scanfFormat="TRH%*d%f%f">
                <variable name="T" units="degC"/>
                <variable name="RH" units="%"/>
            </sample>
            <message separator="\n" position="end" length="0"/>
        </serialSensor>

        <serialSensor ID="Vais_PTB" class="DSMSerialSensor"
            baud="9600" parity="none" databits="8" stopbits="1">
            <!-- |B7  832.44  22.7\r\n| -->
            <sample id="1" rate="0.5" scanfFormat="%*c%*d%f%f">
                <variable name="P" units="mb"/>
                <variable name="Tbaro" units="degC"/>
            </sample>
            <message separator="\n" position="end" length="0"/>
        </serialSensor>

       <serialSensor ID="Garmin_GPS" class="GPS_NMEA_Serial"
            baud="4800" parity="none" databits="8" stopbits="1">

            <!-- GGA record -->
            <sample id="1" rate="1">
                <variable name="GPSsecsofday" units="sec" longname="seconds of day"/>
                <variable name="Lat" units="degree_N" longname="GPS Latitude"/>
                <variable name="Lon" units="degree_E" longname="GPS Longitude"/>
                <variable name="GPSqual" units="none" longname="GPS Qual, 0=inval,1=GPS,2=DGPS"/>
                <variable name="GPSnsat" units="count" longname="Number of GPS satellites tracked"/>
                <variable name="GPShordil" units="none" longname="Horizontal dilution of position"/>
                <variable name="Alt" units="m" longname="GPS Altitude (MSL)"/>
                <variable name="GPSgeoidht" units="m" longname="Height of geoid (MSL) above WGS84 ellipsoid"/>
                <variable name="GPSdage" units="s" longname="time in seconds since last DGPS update"/>
                <variable name="GPSdid" units="none" longname="DGPS station ID number"/>
            </sample>
            <!-- RMC record -->
            <sample id="2" rate="1">
                <variable name="GPSstat" units="none" longname="GPS rcvr status: 1=OK(A), 0=warning(V)"/>
                <variable name="GPSsog" units="m/s" longname="Speed over ground"/>
                <variable name="GPSgmg" units="degree_T" longname="Course made good"/>
                <variable name="GPSvew" units="m/s" longname="East/West velocity"/>
                <variable name="GPSvns" units="m/s" longname="North/South velocity"/>
                <variable name="GPSday" units="day" longname="Day of month (1-31)"/>
                <variable name="GPSmonth" units="month" longname="Month of year (1-12)"/>
                <variable name="GPSyear" units="year" longname="2 digit year"/>
            </sample>
            <message separator="\n" position="end" length="0"/>
        </serialSensor>

    </sensorcatalog>

    <site name="manitou" class="isff.GroundStation">
	<dsm rserialPort="30002" name="marshall" id="1">

	    <!-- GPS input is tee'd to this pseudo-terminal -->
	    <serialSensor IDREF="Garmin_GPS"
		devicename="/var/tmp/gps_pty0" id="30">
	    </serialSensor>

	    <serialSensor IDREF="Vais_PTB"
		devicename="/dev/ttyS9" id="240" height="2m">
	    </serialSensor>

	    <!-- 2m Level -->
	    <serialSensor IDREF="CSAT3"
		devicename="/dev/ttyS1" id="200" height="2m">
		<calfile
		    path="$ISFF/projects/$PROJECT/ISFF/cal_files/$SONIC_DIR:$ISFF/cal_files"
		    file="csat_2m.dat"/>
	    </serialSensor>
	    <serialSensor IDREF="NCAR_SHT"
		devicename="/dev/ttyS5" id="210" height="2m">
	    </serialSensor>

	    <!-- 4m Level -->
	    <serialSensor IDREF="CSAT3"
		devicename="/dev/ttyS10" id="400" height="4m">
		<calfile
		    path="$ISFF/projects/$PROJECT/ISFF/cal_files/$SONIC_DIR:$ISFF/cal_files"
		    file="csat_4m.dat"/>
	    </serialSensor>
	    <serialSensor IDREF="NCAR_SHT"
		devicename="/dev/ttyS11" id="410" height="4m">
	    </serialSensor>

	    <!-- 6m Level -->
	    <serialSensor IDREF="CSAT3"
		devicename="/dev/ttyS12" id="600" height="6m">
		<calfile
		    path="$ISFF/projects/$PROJECT/ISFF/cal_files/$SONIC_DIR:$ISFF/cal_files"
		    file="csat_6m.dat"/>
	    </serialSensor>
	    <serialSensor IDREF="NCAR_SHT"
		devicename="/dev/ttyS13" id="610" height="6m">
	    </serialSensor>

	    <!-- 8m Level -->
	    <serialSensor IDREF="CSAT3"
		devicename="/dev/ttyS14" id="800" height="8m">
		<calfile
		    path="$ISFF/projects/$PROJECT/ISFF/cal_files/$SONIC_DIR:$ISFF/cal_files"
		    file="csat_8m.dat"/>
	    </serialSensor>
	    <serialSensor IDREF="NCAR_SHT"
		devicename="/dev/ttyS15" id="810" height="8m">
	    </serialSensor>

	    <!-- 10m Level -->
	    <serialSensor IDREF="CSAT3"
		devicename="/dev/ttyS16" id="1000" height="10m">
		<calfile
		    path="$ISFF/projects/$PROJECT/ISFF/cal_files/$SONIC_DIR:$ISFF/cal_files"
		    file="csat_10m.dat"/>
	    </serialSensor>
	    <serialSensor IDREF="NCAR_SHT"
		devicename="/dev/ttyS17" id="1010" height="10m">
	    </serialSensor>

	    <!-- ======== MARSHALL OUTPUTS ========== -->

	    <output class="RawSampleOutputStream" sorterLength="0">
		<socket type="server" port="30000"/>
	    </output>

	    <output class="RawSampleOutputStream" sorterLength="0">
		<socket type="dgrequest" address="base"/>
	    </output>

            <processor class="SampleProcessor">
                <output class="UDPSampleOutput">
                    <socket type="dataUDP"/>
                </output>
            </processor>

	    <output class="RawSampleOutputStream" sorterLength="0">
		<fileset dir="$DATAMNT/projects/${PROJECT}/raw_data"
		    file="${DSM}_%Y%m%d_%H%M%S.dat"
		    length="43200">
		    <mount dir="$DATAMNT" dev="/dev/sda1" type="ext3"/>
		</fileset>
	    </output>

	</dsm>
    </site>
    <!-- ================ END MARSHALL SITE DECLARATION ================ -->

    <!-- ================  SERVER DECLARATION ============== -->

    <server>
        <service class="RawSampleService">
            <!-- input from every DSM that has an output of type RawSampleOutputStream -->
            <input class="RawSampleInputStream">
                <socket type="dgaccept"/>
            </input>

            <processor class="SampleArchiver">
                <output class="SampleOutputStream" sorterLength="1000">
                    <fileset dir="$DATA_ARCHIVE"
                        file="isff_%Y%m%d_%H%M%S.dat"
                        length="14400"/>
                </output>
                <output class="SampleOutputStream" sorterLength="0">
                    <socket type="server" port="30000"/>
                </output>
                <output class="SampleOutputStream" sorterLength="0">
                    <socket type="server" path="dsm_data"/>
                </output>
            </processor>

            <processor class="SampleProcessor">
                <output class="UDPSampleOutput">
                    <socket type="dataUDP"/>
                </output>
            </processor>

            <processor class="StatisticsProcessor" id="30000" optional="true">
		<!-- GPS -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="Lat Lon Alt GPSnsat GPSqual"/>
		</sample>

		<!-- 2M SENSORS -->
		<!-- 2m BARO -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="counts" value="counts_baro" type="string"/>
		    <parameter name="invars" type="strings"
			value="P.2m Tbaro.2m"/>
		</sample>

		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="counts" value="counts_4m" type="string"/>
		    <parameter name="invars" type="strings"
			value="u.2m v.2m w.2m tc.2m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="invars" type="strings"
			value="diag.2m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="max"/>
		    <parameter name="invars" type="strings"
			value="spd.2m"/>
		</sample>
		<!-- 2m TRH -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="T.2m RH.2m"/>
		</sample>
		<!-- 4M SENSORS -->
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="counts" value="counts_4m" type="string"/>
		    <parameter name="invars" type="strings"
			value="u.4m v.4m w.4m tc.4m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="invars" type="strings"
			value="diag.4m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="max"/>
		    <parameter name="invars" type="strings"
			value="spd.4m"/>
		</sample>
		<!-- 4m TRH -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="T.4m RH.4m"/>
		</sample>

		<!-- 6M SENSORS -->
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="counts" value="counts_6m" type="string"/>
		    <parameter name="invars" type="strings"
			value="u.6m v.6m w.6m tc.6m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="invars" type="strings"
			value="diag.6m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="max"/>
		    <parameter name="invars" type="strings"
			value="spd.6m"/>
		</sample>
		<!-- 6m TRH -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="T.6m RH.6m"/>
		</sample>

	      <!-- 8M SENSORS -->
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="counts" value="counts_8m" type="string"/>
		    <parameter name="invars" type="strings"
			value="u.8m v.8m w.8m tc.8m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="invars" type="strings"
			value="diag.8m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="max"/>
		    <parameter name="invars" type="strings"
			value="spd.8m"/>
		</sample>
		<!-- 8m TRH -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="T.8m RH.8m"/>
		</sample>

                <!-- 10M SENSORS -->
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="counts" value="counts_10m" type="string"/>
		    <parameter name="invars" type="strings"
			value="u.10m v.10m w.10m tc.10m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="mean"/>
		    <parameter name="invars" type="strings"
			value="diag.10m"/>
		</sample>
		<sample period="300">
		    <parameter name="type" type="string" value="max"/>
		    <parameter name="invars" type="strings"
			value="spd.10m"/>
		</sample>
		<!-- 10m TRH -->
		<sample period="300">
		    <parameter name="type" value="mean" type="string"/>
		    <parameter name="invars" type="strings"
			value="T.10m RH.10m"/>
		</sample>

		<!-- ======== OUTPUTS TO NETCDF ========== -->

                <output class="isff.NetcdfRPCOutput">
                    <ncserver
                        server="localhost"
                        dir="$ISFF/projects/$PROJECT/$SYSTEM/$NETCDF_DIR"
                        file="isff_%Y%m%d.nc" length="86400"
                        cdl="$ISFF/projects/$PROJECT/$SYSTEM/config/isff.cdl"
                        floatFill="1.e37"
                        timeout="300"
                        batchPeriod="300"/>
                </output>

            </processor>
        </service>
    </server>

</project>
